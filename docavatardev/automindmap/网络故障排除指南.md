# Docker网络连接故障排除指南

## 问题描述

当前遇到的主要问题是无法连接到Docker Hub (registry-1.docker.io:443)，导致无法下载基础镜像和推送镜像。

## 症状表现

1. `docker build` 命令失败，提示连接超时
2. `docker pull` 命令无法连接到registry-1.docker.io
3. 镜像构建卡在 "load metadata" 阶段

## 解决方案

### 方案一：使用国内镜像源（推荐）

#### 1. 配置Docker镜像加速器

**Windows系统：**
1. 打开Docker Desktop设置
2. 进入 `Settings > Docker Engine`
3. 修改配置文件如下：

```json
{
  "registry-mirrors": [
    "https://registry.docker-cn.com",
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com",
    "https://ccr.ccs.tencentyun.com"
  ],
  "max-concurrent-downloads": 10,
  "max-concurrent-uploads": 5
}
```

#### 2. 使用国内基础镜像

我们已为您准备了使用国内镜像的Dockerfile：

```bash
# 使用国内镜像构建
docker build -f Dockerfile.国内镜像 -t ai-mindmap:latest .
```

### 方案二：离线构建方案

#### 1. 手动下载基础镜像

如果网络问题持续，可以手动下载基础镜像：

```bash
# 从国内镜像站下载node镜像
docker pull registry.cn-hangzhou.aliyuncs.com/aliyun-node/alpine-node:18

# 重新标记为标准名称
docker tag registry.cn-hangzhou.aliyuncs.com/aliyun-node/alpine-node:18 node:18-alpine
```

#### 2. 使用离线构建

```bash
# 使用标准Dockerfile构建
docker build -t ai-mindmap:latest .
```

### 方案三：一键修复脚本

我们已为您准备了专门的修复脚本：

1. **网络修复-一键脚本.bat** - 自动配置国内镜像源
2. **Docker网络修复-9301端口.bat** - 完整修复和部署流程

## 验证步骤

### 1. 测试网络连接

```bash
# 测试Docker Hub连接
docker pull hello-world

# 测试国内镜像连接
docker pull registry.cn-hangzhou.aliyuncs.com/aliyun-node/alpine-node:18
```

### 2. 验证镜像构建

```bash
# 清理旧镜像
docker rmi ai-mindmap:latest 2>nul

# 重新构建
docker build -t ai-mindmap:latest .
```

### 3. 启动容器验证

```bash
# 启动容器
docker run -d -p 9301:9301 --name ai-mindmap-app ai-mindmap:latest

# 检查容器状态
docker ps | grep ai-mindmap-app

# 测试健康检查
curl http://localhost:9301/health
```

## 常见错误及解决

### 错误1：连接超时
```
dial tcp 31.13.64.7:443: connectex: A connection attempt failed
```
**解决：** 使用国内镜像源或配置代理

### 错误2：DNS解析失败
```
failed to resolve reference
```
**解决：** 配置DNS服务器为8.8.8.8或114.114.114.114

### 错误3：镜像不存在
```
Unable to find image 'ai-mindmap:latest' locally
```
**解决：** 先执行构建命令：`docker build -t ai-mindmap:latest .`

## 网络诊断工具

### 1. 测试网络连通性

```bash
# 测试Docker Hub连通性
curl -v https://registry-1.docker.io/v2/

# 测试国内镜像连通性
curl -v https://registry.docker-cn.com/v2/
```

### 2. 检查Docker配置

```bash
# 查看当前配置
docker info | grep -i registry

# 查看镜像加速器配置
cat ~/.docker/daemon.json
```

## 备用构建方案

如果所有网络方案都失败，可以使用以下备用方案：

### 1. 使用已下载的镜像

如果您之前成功下载过node:18-alpine镜像，可以直接使用：

```bash
# 检查本地镜像
docker images node:18-alpine

# 如果有镜像，直接构建
docker build -t ai-mindmap:latest .
```

### 2. 使用替代基础镜像

```bash
# 使用Ubuntu基础镜像
FROM ubuntu:20.04
RUN apt-get update && apt-get install -y nodejs npm curl
```

## 联系支持

如果以上方案都无法解决问题：

1. 检查网络防火墙设置
2. 确认是否使用了代理服务器
3. 尝试使用手机热点等替代网络
4. 联系网络管理员检查网络策略

## 快速开始

**立即执行以下命令：**

```bash
# 1. 运行网络修复脚本
双击运行：网络修复-一键脚本.bat

# 2. 使用国内镜像构建
docker build -f Dockerfile.国内镜像 -t ai-mindmap:latest .

# 3. 启动应用
docker run -d -p 9301:9301 --name ai-mindmap-app ai-mindmap:latest
```