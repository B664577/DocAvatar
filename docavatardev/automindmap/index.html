<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¢å¼ºæ€ç»´å¯¼å›¾ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="styles.css?v=3">
    <style>
      /* Embed æ¨¡å¼ä¸‹çš„å¸ƒå±€è¦†ç›–ï¼ˆä»…å±•ç¤ºå±‚ï¼Œä¸æ”¹åŸæ ·å¼æ–‡ä»¶ï¼‰ */
      body.embed-right .left-panel { display: none !important; }
      body.embed-right .right-panel { flex: 1 1 auto !important; width: 100vw !important; max-width: 100vw !important; }
      body.embed-right .main-container { width: 100vw !important; }
      body.embed-settings .right-panel { display: none !important; }
      body.embed-settings .left-panel { flex: 1 1 auto !important; width: 100vw !important; max-width: 100vw !important; }
      /* å¸¦èƒŒï¼ˆmemï¼‰æ¨¡å¼ï¼šå·¦ 1/3ï¼Œå³ 2/3 */
      body.embed-mem .main-container { width: 100vw !important; display:flex !important; flex-direction: row !important; }
      body.embed-mem .left-panel { display:flex !important; flex: 0 0 34vw !important; max-width: 34vw !important; min-width: 34vw !important; }
      body.embed-mem .right-panel { display:flex !important; flex: 1 1 auto !important; width: calc(100vw - 34vw) !important; max-width: calc(100vw - 34vw) !important; }
      /* å¼ºåˆ¶è¦†ç›–å“åº”å¼ï¼šåœ¨ mem æ¨¡å¼ä¸‹ä¿æŒå·¦å³ */
      @media (max-width: 1200px){ body.embed-mem .main-container{flex-direction:row !important;} }
      @media (max-width: 768px){ body.embed-mem .main-container{flex-direction:row !important;} }
    </style>
    
    <!-- Markmapç›¸å…³ä¾èµ– - ä½¿ç”¨CDN -->
    <script src="https://unpkg.com/d3@6.7.0/dist/d3.min.js"></script>
    <script src="https://unpkg.com/markmap-view@0.14.4/dist/index.min.js"></script>
    <script src="https://unpkg.com/markmap-lib@0.14.4/dist/browser/index.min.js"></script>
    
    <!-- PDF.js for PDF viewing - åœ¨ embed æ¨¡å¼ä¸‹è·³è¿‡è¿œç¨‹ ESM ä»¥é¿å… CORS -->
    <script type="module">
        try{
          const qs = new URLSearchParams(location.search);
          const isEmbed = qs.get('embed') === '1';
          if(!isEmbed){
            // é¿å… CORS æŠ¥é”™ï¼šä¸åœ¨ dev åµŒå…¥åœºæ™¯å¼‚æ­¥åŠ è½½è¿œç¨‹ ESMï¼Œç»Ÿä¸€ç¦ç”¨ï¼ˆPDF é¢„è§ˆéå¿…è¦ï¼‰
            window.pdfjsLib = {};
          } else {
            window.pdfjsLib = {};
          }
        }catch(e){ window.pdfjsLib = {}; }
    </script>
    
    <!-- html2canvas for screenshot functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script>
      // é˜²æ­¢å¤–éƒ¨ç¯å¢ƒè¯¯æŠŠç›®æ ‡æºé™åˆ¶ä¸º huggingface.coï¼Œç»Ÿä¸€æ”¾å®½ä¸º '*'
      (function(){
        try{
          var protoPM = (window.Window && window.Window.prototype && window.Window.prototype.postMessage) ? window.Window.prototype.postMessage : null;
          if(protoPM){
            window.Window.prototype.postMessage = function(msg, origin, transfer){
              try{
                if(typeof origin === 'string' && origin.indexOf('huggingface.co') !== -1) origin = '*';
                return protoPM.call(this, msg, origin, transfer);
              }catch(e){ try{ return protoPM.call(this, msg, '*', transfer); }catch(_){} }
            };
          }
          var _pm = window.postMessage ? window.postMessage.bind(window) : null;
          if(_pm){
            window.postMessage = function(msg, origin, transfer){
              try{
                if(typeof origin === 'string' && origin.indexOf('huggingface.co') !== -1) origin = '*';
                return _pm(msg, origin, transfer);
              }catch(e){ try{ return _pm(msg, '*', transfer); }catch(_){} }
            };
          }
        }catch(e){}
      })();
      // è§£æ URL æŸ¥è¯¢å‚æ•°ï¼Œè®¾ç½®åµŒå…¥æ¨¡å¼ class
      (function(){
        try{
          const qs = new URLSearchParams(location.search);
          // è®°å½• automindmap æœåŠ¡å™¨åŸºå€ï¼Œä¾›è·¨æºè°ƒç”¨æŒä¹…åŒ–æ¥å£
          try{ window.__AM_BASE__ = (qs.get('am_base') || '').replace(/\/$/, ''); }catch(_e){}
          if(qs.get('embed') === '1'){
            const layout = qs.get('layout');
            const mode = qs.get('mode');
            if(layout === 'right-only') document.addEventListener('DOMContentLoaded', function(){ document.body.classList.add('embed-right'); });
            if(mode === 'settings') document.addEventListener('DOMContentLoaded', function(){ document.body.classList.add('embed-settings'); });
            if(mode === 'mem') document.addEventListener('DOMContentLoaded', function(){ document.body.classList.add('embed-mem'); });
          }
        }catch(e){}
      })();

      // è¯»å–ä¸»åº”ç”¨é€ä¼ çš„ mm_* å‚æ•°ä¸ init_mdï¼ŒæŒ‰â€œå·²æœ‰ä¼˜å…ˆã€å¯é€‰è¦†ç›–â€çš„ç­–ç•¥æ¢å¤ï¼›ä¸å†æ— æ¡ä»¶è¦†ç›–æœ¬åœ°
      (function(){
        async function applyParams(){
          try{
            const qs = new URLSearchParams(location.search);
            const skipServer = qs.get('mm_no_server') === '1';
            const isIframe = (function(){ try{ return window.self !== window.top; }catch(_e){ return true; }})();
            const foreignPort = (function(){ try{ var p=String(location.port||''); return !!p && p !== '5173'; }catch(_e){ return false; } })();
            const apiBase = qs.get('mm_api_base');
            const model = qs.get('mm_model');
            const sys = qs.get('mm_sys');
            const user = qs.get('mm_user');
            const key = qs.get('mm_key');
            const override = qs.get('mm_override') === '1';
            const forceUpdate = qs.get('mm_force_update') === '1';
            const initMdFromUrl = qs.get('init_md') || '';

            // å…ˆå°è¯•ä»æœåŠ¡ç«¯æ¢å¤å®Œæ•´ UI å€¼ï¼ˆè‹¥æœªç¦ç”¨ï¼Œä¸”é iframe åœºæ™¯ï¼‰
            // ä½†å¦‚æœæœ‰force_updateæ ‡å¿—ï¼Œåˆ™è·³è¿‡æœåŠ¡ç«¯æ¢å¤ï¼Œä¼˜å…ˆä½¿ç”¨URLå‚æ•°
            try{
              if(!skipServer && !isIframe && !foreignPort && !forceUpdate){
              const base = (window.__AM_BASE__ || '');
              const cfg = await fetch((base? (base + '/export-settings') : '/export-settings')).then(r=>r.ok?r.json():{}).catch(()=>({}));
              if(cfg && cfg.ui_values){
                Object.keys(cfg.ui_values).forEach(function(id){
                  const el = document.getElementById(id); if(!el) return;
                  const v = cfg.ui_values[id];
                  if(el.type==='checkbox'||el.type==='radio'){ el.checked=!!v; } else { el.value=(v!=null?String(v):''); }
                });
                try{ localStorage.setItem('ui_values', JSON.stringify(cfg.ui_values)); }catch(_e){}
              }
              // ä¼˜å…ˆä½¿ç”¨ ui_values ä¸­çš„æ§ä»¶å€¼å†™å› localStorageï¼Œé¿å…é¡¶å±‚é»˜è®¤å€¼è¦†ç›–
              try{
                var uiv = (cfg && cfg.ui_values) ? cfg.ui_values : {};
                var apiBaseV = (uiv['mindmap-api-base']!=null) ? uiv['mindmap-api-base'] : (cfg ? cfg.mindmap_api_base : null);
                var modelV = (uiv['mindmap-model-select']!=null) ? uiv['mindmap-model-select'] : (cfg ? cfg.mindmap_model : null);
                var sysV = (uiv['mindmap-system-prompt']!=null) ? uiv['mindmap-system-prompt'] : (cfg ? cfg.mindmap_system_prompt : null);
                var userV = (uiv['mindmap-user-prompt-template']!=null) ? uiv['mindmap-user-prompt-template'] : (cfg ? cfg.mindmap_user_prompt : null);
                var keyV = (uiv['mindmap-api-key']!=null) ? uiv['mindmap-api-key'] : (cfg ? cfg.mindmap_api_key : null);
                if(apiBaseV!=null) localStorage.setItem('mindmap-api-base', String(apiBaseV||''));
                if(modelV!=null) localStorage.setItem('mindmap-model', String(modelV||''));
                if(sysV!=null) localStorage.setItem('mindmap-system-prompt', String(sysV||''));
                if(userV!=null) localStorage.setItem('mindmap-user-prompt-template', String(userV||''));
                if(keyV!=null) localStorage.setItem('mindmap-api-key', String(keyV||''));
              }catch(_e){}
              }
            }catch(_e){}

            // æ ¹æ®æ˜¯å¦ override æˆ– force_update å†³å®šæ˜¯å¦ç”¨ URL è¦†ç›–ç°æœ‰é…ç½®
            const hasLocalModel = !!localStorage.getItem('mindmap-model');
            if(forceUpdate || override || !hasLocalModel){
              if(apiBase) localStorage.setItem('mindmap-api-base', apiBase);
              if(model) localStorage.setItem('mindmap-model', model);
              if(sys) localStorage.setItem('mindmap-system-prompt', sys);
              if(user) localStorage.setItem('mindmap-user-prompt-template', user);
              if(key) localStorage.setItem('mindmap-api-key', key);
              
              // å¦‚æœæ˜¯force_updateï¼Œç«‹å³åº”ç”¨åˆ°UIæ§ä»¶
              if(forceUpdate){
                try{
                  if(apiBase){ const el=document.getElementById('mindmap-api-base'); if(el) el.value=apiBase; }
                  if(model){ const el=document.getElementById('mindmap-model-select'); if(el) el.value=model; }
                  if(sys){ const el=document.getElementById('mindmap-system-prompt'); if(el) el.value=sys; }
                  if(user){ const el=document.getElementById('mindmap-user-prompt-template'); if(el) el.value=user; }
                  if(key){ const el=document.getElementById('mindmap-api-key'); if(el) el.value=key; }
                }catch(e){}
              }
            }

            if(initMdFromUrl){ try{ localStorage.setItem('mindmap_init_md', initMdFromUrl); }catch(e){} }

            // ä¸å†å¼ºåˆ¶ç”¨ localStorage è¦†ç›– UIï¼Œé¿å…è¦†ç›–åˆšä»æœåŠ¡å™¨æ¢å¤çš„ ui_values
          }catch(e){}
        }
        // æš´éœ²åˆ°å…¨å±€ï¼Œä¾›å…¶å®ƒåˆå§‹åŒ–ç‰‡æ®µå®‰å…¨è°ƒç”¨ï¼ˆå…¼å®¹ window.applyParams ä¸ window.__applyParamsï¼‰
        try{ window.__applyParams = applyParams; window.applyParams = applyParams; }catch(_e){}
        // å»¶ååˆ° restore ä¹‹åå†è°ƒç”¨ï¼ˆé¿å…å…ˆè¢«æœåŠ¡å™¨è¦†ç›–ï¼‰
      })();

      // ç›‘å¬è®¾ç½®æ›´æ”¹ï¼Œä¿å­˜åˆ°æœ¬åœ° serverï¼ˆä¾¿äºä¸»åº”ç”¨åŒæ­¥åŠ è½½ï¼‰
      (function(){
        // æ”¶é›†é¡µé¢ä¸Šæ‰€æœ‰å¯æŒä¹…åŒ–çš„è¡¨å•å…ƒç´ å€¼
        function setCookie(name, value, days){
          try{
            var exp = new Date();
            exp.setTime(exp.getTime() + (days||365)*24*60*60*1000);
            document.cookie = name + '=' + encodeURIComponent(String(value||'')) + ';expires=' + exp.toUTCString() + ';path=/';
          }catch(e){}
        }
        function getCookie(name){
          try{
            var arr = document.cookie.split(';');
            for(var i=0;i<arr.length;i++){
              var kv = arr[i].trim();
              if(kv.indexOf(name+'=')===0){ return decodeURIComponent(kv.substring(name.length+1)); }
            }
          }catch(e){}
          return '';
        }
        function collectUIValues(){
          const map = {};
          try{
            const els = document.querySelectorAll('input, textarea, select');
            els.forEach(function(el){
              if(!el.id) return;
              let v = null;
              if(el.type === 'checkbox' || el.type === 'radio'){
                v = !!el.checked;
              }else{
                v = el.value;
              }
              map[el.id] = v;
            });
          }catch(e){}
          return map;
        }
        function applyUIValues(values){
          try{
            Object.keys(values||{}).forEach(function(id){
              const el = document.getElementById(id);
              if(!el) return;
              const v = values[id];
              if(el.type === 'checkbox' || el.type === 'radio'){
                el.checked = !!v;
              }else{
                el.value = v != null ? String(v) : '';
              }
            });
          }catch(e){}
        }
        function syncSettings(){
          try{
            const payload = {
              mindmap_api_base: localStorage.getItem('mindmap-api-base') || '',
              mindmap_model: document.getElementById('mindmap-model-select')?.value || localStorage.getItem('mindmap-model') || '',
              mindmap_system_prompt: document.getElementById('mindmap-system-prompt')?.value || localStorage.getItem('mindmap-system-prompt') || '',
              mindmap_user_prompt: document.getElementById('mindmap-user-prompt-template')?.value || localStorage.getItem('mindmap-user-prompt-template') || '',
              mindmap_api_key: document.getElementById('mindmap-api-key')?.value || localStorage.getItem('mindmap-api-key') || '',
              ui_values: collectUIValues()
            };
            // å†™æœ¬åœ°å­˜å‚¨ï¼Œä¿è¯åˆ·æ–°ä¸ä¸¢ï¼›åŒæ—¶åŒæ­¥åˆ°æœ¬åœ°æœåŠ¡ï¼Œä¿è¯æ¢ç«¯å£/è·¨ä¼šè¯
            try{
              localStorage.setItem('mindmap-model', payload.mindmap_model || '');
              if(payload.mindmap_api_base!=null) localStorage.setItem('mindmap-api-base', payload.mindmap_api_base);
              if(payload.mindmap_system_prompt!=null) localStorage.setItem('mindmap-system-prompt', payload.mindmap_system_prompt);
              if(payload.mindmap_user_prompt!=null) localStorage.setItem('mindmap-user-prompt-template', payload.mindmap_user_prompt);
              if(payload.mindmap_api_key!=null) localStorage.setItem('mindmap-api-key', payload.mindmap_api_key);
              // ä¿å­˜å®Œæ•´çš„ UI å€¼æ˜ å°„
              localStorage.setItem('ui_values', JSON.stringify(payload.ui_values||{}));
              // è·¨ç«¯å£æŒä¹…ï¼šå†™ Cookieï¼ˆä¸åŒä¸´æ—¶ç«¯å£ä¹Ÿå¯è¯»ï¼‰
              setCookie('am_ui_values', JSON.stringify(payload.ui_values||{}));
              setCookie('am_mindmap', JSON.stringify({
                api_base: payload.mindmap_api_base||'',
                model: payload.mindmap_model||'',
                sys: payload.mindmap_system_prompt||'',
                user: payload.mindmap_user_prompt||'',
                key: payload.mindmap_api_key||''
              }));
            }catch(e){}
            // å°†å…³é”®å­—æ®µå†™å…¥ URLï¼ˆmm_* å‚æ•° + mm_override=1 + mm_force_update=1ï¼‰ï¼Œä¿è¯åˆ·æ–°/ä»£ç†ç«¯å£å˜åŒ–æ—¶ä¹Ÿèƒ½æ¢å¤
            try{
              const qs = new URLSearchParams(location.search);
              qs.set('mm_api_base', payload.mindmap_api_base||'');
              qs.set('mm_model', payload.mindmap_model||'');
              qs.set('mm_sys', payload.mindmap_system_prompt||'');
              qs.set('mm_user', payload.mindmap_user_prompt||'');
              if(payload.mindmap_api_key) qs.set('mm_key', payload.mindmap_api_key); else qs.delete('mm_key');
              qs.set('mm_override', '1');
              qs.set('mm_force_update', '1');
              if(!qs.get('embed')) qs.set('embed','1');
              if(!qs.get('mode')) qs.set('mode','settings');
              const newUrl = location.pathname + '?' + qs.toString() + location.hash;
              history.replaceState(null, '', newUrl);
            }catch(_e){}
            // åŒæ—¶æŠ•é€’åˆ°å¤šæ¡è·¯å¾„ï¼šam_base/save-settingsã€/save-settingsï¼ˆåŒæºï¼‰ã€/am/save-settingsï¼ˆç» 7860 è½¬å‘ï¼‰
            try{
              const base = (window.__AM_BASE__ || '');
              const targets = [];
              if(base) targets.push(base + '/save-settings');
              targets.push('/save-settings');
              targets.push('/am/save-settings');
              targets.forEach(function(u){
                try{ fetch(u, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).catch(()=>{}); }catch(_e){}
              });
            }catch(_e){}
          }catch(e){}
        }
        function bind(){
          const ids = ['mindmap-model-select','mindmap-api-key','mindmap-system-prompt','mindmap-user-prompt-template'];
          ids.forEach(id=>{
            const el = document.getElementById(id);
            if(!el) return;
            const evt = (el.tagName === 'SELECT') ? 'change' : 'input';
            el.addEventListener(evt, syncSettings);
          });
          // ä¸‹æ‹‰æ¨¡å‹é€‰æ‹©æ—¶ï¼Œç«‹å³å†™å…¥ localStorage å¹¶åŒæ­¥ä¿å­˜ï¼Œä¿æŒä¸ 5079 é…ç½®é¡µä¸€è‡´
          try{
            const sel = document.getElementById('mindmap-model-select');
            if(sel){ sel.addEventListener('change', function(){ try{ localStorage.setItem('mindmap-model', sel.value||''); }catch(_e){}; syncSettings(); }); }
          }catch(_e){}
          // ç»™æ‰€æœ‰è¡¨å•å…ƒç´ ç»‘å®šè‡ªåŠ¨ä¿å­˜
          try{
            const els = document.querySelectorAll('input, textarea, select');
            const handler = debounce(syncSettings, 200);
            els.forEach(function(el){
              const evt = (el.tagName === 'SELECT') ? 'change' : (el.type==='checkbox'||el.type==='radio' ? 'change' : 'input');
              el.addEventListener(evt, handler);
            });
          }catch(e){}
          // æ‰‹åŠ¨ä¿å­˜æŒ‰é’®
          try{
            const btn = document.getElementById('save-all-settings-btn');
            const hint = document.getElementById('save-all-hint');
            if(btn){
              btn.addEventListener('click', function(){
                // å¼ºåˆ¶ä¿å­˜ä¸€æ¬¡ï¼Œå¹¶æ˜¾å¼å†™å…¥ /save-settings
                try{
                  const payload = {
                    mindmap_api_base: (document.getElementById('mindmap-api-base')?.value || localStorage.getItem('mindmap-api-base') || ''),
                    mindmap_model: (document.getElementById('mindmap-model-select')?.value || localStorage.getItem('mindmap-model') || ''),
                    mindmap_system_prompt: (document.getElementById('mindmap-system-prompt')?.value || localStorage.getItem('mindmap-system-prompt') || ''),
                    mindmap_user_prompt: (document.getElementById('mindmap-user-prompt-template')?.value || localStorage.getItem('mindmap-user-prompt-template') || ''),
                    mindmap_api_key: (document.getElementById('mindmap-api-key')?.value || localStorage.getItem('mindmap-api-key') || ''),
                    ui_values: collectUIValues()
                  };
                  try{ localStorage.setItem('ui_values', JSON.stringify(payload.ui_values||{})); }catch(_e){}
                  try{ if(payload.mindmap_api_base!=null) localStorage.setItem('mindmap-api-base', payload.mindmap_api_base); }catch(_e){}
                  try{ if(payload.mindmap_model!=null) localStorage.setItem('mindmap-model', payload.mindmap_model); }catch(_e){}
                  try{ if(payload.mindmap_system_prompt!=null) localStorage.setItem('mindmap-system-prompt', payload.mindmap_system_prompt); }catch(_e){}
                  try{ if(payload.mindmap_user_prompt!=null) localStorage.setItem('mindmap-user-prompt-template', payload.mindmap_user_prompt); }catch(_e){}
                  try{ if(payload.mindmap_api_key!=null) localStorage.setItem('mindmap-api-key', payload.mindmap_api_key); }catch(_e){}
                  const base = (window.__AM_BASE__ || '');
                  fetch((base? (base + '/save-settings') : '/save-settings'), { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) })
                    .then(()=>{ if(hint){ hint.style.display='inline'; setTimeout(()=>{ hint.style.display='none'; }, 1200); } })
                    .catch(()=>{ if(hint){ hint.textContent='ä¿å­˜å¤±è´¥'; hint.style.display='inline'; setTimeout(()=>{ hint.style.display='none'; hint.textContent='å·²ä¿å­˜'; }, 2000); } });
                }catch(_e){}
              });
            }
            // å•ç‹¬â€œä¿å­˜ API Baseâ€ä¸â€œä¿å­˜ Keyâ€
            const svBase = document.getElementById('save-mindmap-api-base');
            if(svBase){ svBase.addEventListener('click', function(){ try{ const v = document.getElementById('mindmap-api-base')?.value || ''; localStorage.setItem('mindmap-api-base', v); const base=(window.__AM_BASE__||''); fetch((base? (base + '/save-settings') : '/save-settings'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mindmap_api_base:v,ui_values:collectUIValues()})}); }catch(_e){} }); }
            const svKey = document.getElementById('save-mindmap-api-key');
            if(svKey){ svKey.addEventListener('click', function(){ try{ const v = document.getElementById('mindmap-api-key')?.value || ''; localStorage.setItem('mindmap-api-key', v); const base=(window.__AM_BASE__||''); fetch((base? (base + '/save-settings') : '/save-settings'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mindmap_api_key:v,ui_values:collectUIValues()})}); }catch(_e){} }); }
          }catch(e){}
        }
        // æ¢å¤ UI å€¼ï¼šä¼˜å…ˆæœ¬åœ° ui_valuesï¼Œç„¶åç”¨æœåŠ¡å™¨ ui_values ä»…è¡¥ç©ºï¼Œä¸è¦†ç›–å·²æœ‰å€¼ï¼›æœ€ååº”ç”¨ URL mm_* è¦†ç›–
        function restore(){
          try{
            // 1) æ¢å¤ç­–ç•¥ï¼š
            // - é embed åœºæ™¯ï¼šCookie â†’ æœ¬åœ° ui_valuesï¼ˆä¿æŒåŸè¡Œä¸ºï¼Œå…¼å®¹ç‹¬ç«‹è®¿é—®ï¼‰
            // - embed åœºæ™¯ï¼šè·³è¿‡ Cookie ä¸æœ¬åœ° ui_valuesï¼Œé¿å…æ—§å€¼è¦†ç›– 7860 æ¨é€çš„æœåŠ¡å™¨é…ç½®
            try{
              const isEmbed = (function(){ try{ return (new URLSearchParams(location.search)).get('embed')==='1'; }catch(_e){ return false; } })();
              if(!isEmbed){
                try{ const c = getCookie('am_ui_values'); if(c){ const v = JSON.parse(c||'{}'); applyUIValues(v); } }catch(_e){}
                try{ const local = JSON.parse(localStorage.getItem('ui_values')||'{}'); applyUIValues(local); }catch(_e){}
              }
            }catch(_e){}

            // åŒæ­¥ Cookie ä¸­çš„æ ¸å¿ƒ mindmap å­—æ®µåˆ° localStorage ä¸ UI
            try{
              const coreStr = getCookie('am_mindmap');
              if(coreStr){
                const core = JSON.parse(coreStr||'{}');
                if(core.api_base!=null){ localStorage.setItem('mindmap-api-base', core.api_base||''); var el=document.getElementById('mindmap-api-base'); if(el && !el.value) el.value = core.api_base||''; }
                if(core.model!=null){ localStorage.setItem('mindmap-model', core.model||''); var m=document.getElementById('mindmap-model-select'); if(m && !m.value) m.value = core.model||''; }
                if(core.sys!=null){ localStorage.setItem('mindmap-system-prompt', core.sys||''); var s=document.getElementById('mindmap-system-prompt'); if(s && !s.value) s.value = core.sys||''; }
                if(core.user!=null){ localStorage.setItem('mindmap-user-prompt-template', core.user||''); var u=document.getElementById('mindmap-user-prompt-template'); if(u && !u.value) u.value = core.user||''; }
                if(core.key!=null){ localStorage.setItem('mindmap-api-key', core.key||''); var k=document.getElementById('mindmap-api-key'); if(k && !k.value) k.value = core.key||''; }
              }
            }catch(_e){}

            // 2) å†ä»æœåŠ¡å™¨è¯»å–ï¼Œä»…è¡¥ç©ºï¼ˆä¸è¦†ç›–å·²å­˜åœ¨å€¼ï¼‰
            function applyIfEmpty(values){
              try{
                Object.keys(values||{}).forEach(function(id){
                  var el = document.getElementById(id); if(!el) return;
                  var cur = (el.type==='checkbox'||el.type==='radio') ? (el.checked? '1':'' ) : (el.value||'');
                  if(!cur){
                    var v = values[id];
                    if(el.type==='checkbox'||el.type==='radio'){ el.checked = !!v; } else { el.value = (v!=null? String(v):''); }
                  }
                });
              }catch(_e){}
            }
            const base = (window.__AM_BASE__ || '');
            // åœ¨force_updateæ¨¡å¼ä¸‹ï¼Œè·³è¿‡æœåŠ¡å™¨é…ç½®åŠ è½½ï¼Œé¿å…è¦†ç›–URLå‚æ•°ä¼ é€’çš„é…ç½®
            const forceUpdateCheck = (function(){ try{ return (new URLSearchParams(location.search)).get('mm_force_update')==='1'; }catch(_e){ return false; } })();
            if(!forceUpdateCheck){
              fetch((base? (base + '/export-settings') : '/export-settings')).then(r=>r.ok?r.json():null).then(cfg=>{
                const serverUI = (cfg && cfg.ui_values) ? cfg.ui_values : null;
                try{
                  const isEmbed = (function(){ try{ return (new URLSearchParams(location.search)).get('embed')==='1'; }catch(_e){ return false; } })();
                  if(serverUI){
                    // åœ¨ embed åœºæ™¯ä¸‹ï¼Œæ— æ¡ä»¶åº”ç”¨æœåŠ¡å™¨ ui_valuesï¼ˆ7860 å·²é¢„å…ˆæ¨é€æœ€æ–°é…ç½®ï¼‰
                    // é embed åœºæ™¯æ²¿ç”¨"ä»…è¡¥ç©º"çš„æ¸©å’Œç­–ç•¥
                    if(isEmbed){ applyUIValues(serverUI); }
                    else { applyIfEmpty(serverUI); }
                  }
                }catch(_e){ if(serverUI) applyIfEmpty(serverUI); }
              // å°†å…³é”® mindmap å­—æ®µåŒæ­¥å› localStorageï¼Œä»¥ä¾› mem æ¨¡å¼ä½¿ç”¨
              try{
                const mSel = document.getElementById('mindmap-model-select'); if(mSel) localStorage.setItem('mindmap-model', mSel.value||'');
                const mKey = document.getElementById('mindmap-api-key'); if(mKey) localStorage.setItem('mindmap-api-key', mKey.value||'');
                const mSys = document.getElementById('mindmap-system-prompt'); if(mSys) localStorage.setItem('mindmap-system-prompt', mSys.value||'');
                const mUser = document.getElementById('mindmap-user-prompt-template'); if(mUser) localStorage.setItem('mindmap-user-prompt-template', mUser.value||'');
              }catch(_e){}
            }).catch(()=>{});
            }

            // 3) æœ€ååº”ç”¨ URL è¦†ç›–ï¼ˆmm_override=1 æˆ– mm_force_update=1ï¼‰
            try{
              const qs = new URLSearchParams(location.search);
              const override = qs.get('mm_override') === '1';
              const forceUpdate2 = qs.get('mm_force_update') === '1';
              if(override || forceUpdate2){
                const apiBase = qs.get('mm_api_base');
                const model = qs.get('mm_model');
                const sys = qs.get('mm_sys');
                const user = qs.get('mm_user');
                const key = qs.get('mm_key');
                if(apiBase!=null){ const el=document.getElementById('mindmap-api-base'); if(el) el.value=apiBase; localStorage.setItem('mindmap-api-base', apiBase); }
                if(model!=null){ const el=document.getElementById('mindmap-model-select'); if(el) el.value=model; localStorage.setItem('mindmap-model', model); }
                if(sys!=null){ const el=document.getElementById('mindmap-system-prompt'); if(el) el.value=sys; localStorage.setItem('mindmap-system-prompt', sys); }
                if(user!=null){ const el=document.getElementById('mindmap-user-prompt-template'); if(el) el.value=user; localStorage.setItem('mindmap-user-prompt-template', user); }
                if(key!=null){ const el=document.getElementById('mindmap-api-key'); if(el) el.value=key; localStorage.setItem('mindmap-api-key', key); }
              }
            }catch(_ee){}
          }catch(e){}
        }
        document.addEventListener('DOMContentLoaded', function(){
          try{ restore(); }catch(_e){}
          try{ bind(); }catch(_e){}
          try{ (window.applyParams||window.__applyParams||function(){})(); }catch(_e){}
          try{
            var isEmbed = (new URLSearchParams(location.search)).get('embed')==='1';
            if(!isEmbed){ setTimeout(syncSettings, 400); }
          }catch(_e){ setTimeout(syncSettings, 400); }
        });
      })();

      // å¸¦èƒŒæ¨¡å¼ï¼šåˆ†å—ã€ç¼“å­˜ã€é¢æ¿ä¸æ³¨å…¥ï¼ˆæ»¡è¶³â€œæœ€æ·±æ ‡é¢˜ä¸ºè¾¹ç•Œï¼›å›¾ç‰‡base64ä»…å±•ç¤ºä¸å…¥å‚ï¼›æ–­ç‚¹ç»­è·‘â€ï¼‰
      (function(){
        const qs = new URLSearchParams(location.search);
        if(!(qs.get('embed')==='1' && qs.get('mode')==='mem')) return;
        function stripBase64Imgs(md){
          try{ return md.replace(/!\[[^\]]*\]\(data:image\/[\w+\-.]+;base64,[^)]+\)/g,''); }catch(e){ return md; }
        }
        // è‹¥æ”¶åˆ°çš„æ˜¯æŠ˜å HTMLï¼ˆ<summary><span class="hN">ï¼‰ï¼Œå°†å…¶è½¬æ¢æˆæ ‡å‡† Markdownï¼ˆ# æ ‡é¢˜ï¼‰
        function htmlFoldToMarkdown(txt){
          if(!txt || typeof txt!=='string') return '';
          if(!/<summary[^>]*>\s*<span class=\"h\d\">/i.test(txt)) return txt; // éæŠ˜å HTMLç›´æ¥è¿”å›
          try{
            // æå–æ‰€æœ‰ summary æ ‡é¢˜ï¼Œè½¬ä¸º #ã€##ã€###
            let md = txt
              .replace(/<summary[^>]*>\s*<span class=\"h1\">([\s\S]*?)<\/span>\s*<\/summary>/gi, function(_m,t){return '\n# '+t.replace(/<[^>]+>/g,'').trim()+'\n';})
              .replace(/<summary[^>]*>\s*<span class=\"h2\">([\s\S]*?)<\/span>\s*<\/summary>/gi, function(_m,t){return '\n## '+t.replace(/<[^>]+>/g,'').trim()+'\n';})
              .replace(/<summary[^>]*>\s*<span class=\"h3\">([\s\S]*?)<\/span>\s*<\/summary>/gi, function(_m,t){return '\n### '+t.replace(/<[^>]+>/g,'').trim()+'\n';})
              .replace(/<summary[^>]*>\s*<span class=\"h(\d)\">([\s\S]*?)<\/span>\s*<\/summary>/gi, function(_m,l,t){var n=parseInt(l,10)||4; return '\n'+('#'.repeat(Math.min(Math.max(n,1),6)))+' '+String(t).replace(/<[^>]+>/g,'').trim()+'\n';});
            // å»æ‰å‰©ä½™ details/summary å¤–å£³ä¸å¤šä½™æ ‡ç­¾
            md = md.replace(/<\/?details[^>]*>/gi,'').replace(/<[^>]+>/g,'');
            return md;
          }catch(e){ return txt; }
        }
        function detectDeepestLevel(lines){
          let inCode=false,deep=0; for(const L of lines){
            if(/^```/.test(L)){ inCode=!inCode; continue; }
            if(inCode) continue; const m=/^(#{1,6})\s+/.exec(L); if(m){ const lv=m[1].length; if(lv>deep) deep=lv; }
          } return deep;
        }
        function splitByDeepest(md){
          // å…¼å®¹ï¼šè‹¥æ˜¯æŠ˜å HTMLï¼Œå…ˆè½¬æ¢ä¸ºæ ‡å‡†Markdown
          md = htmlFoldToMarkdown(md);
          const lines = md.split(/\r?\n/);
          const segs = [];
          let buf = [];
          let inCode = false;
          let started = false; // æ˜¯å¦å·²è¿›å…¥ä¸€ä¸ªæ®µçš„èŒƒå›´ï¼ˆé€šå¸¸é‡åˆ°ç¬¬ä¸€ä¸ªæ ‡é¢˜åï¼‰
          let seenBody = false; // è‡ªä¸Šä¸€æ¬¡â€œå¼€å§‹/åˆ‡æ®µâ€ä»¥æ¥æ˜¯å¦å‡ºç°è¿‡æ­£æ–‡ï¼ˆéæ ‡é¢˜ã€éç©ºã€éä»£ç å›´æ ï¼‰

          function isHeading(l){ return /^#{1,6}\s+/.test(l); }
          function isFence(l){ return /^```/.test(l); }
          function isNonEmpty(l){ return /\S/.test(l); }
          function flush(){ if(buf.length){ segs.push(buf.join('\n').trim()); buf = []; } started = false; seenBody = false; }

          for(let i=0;i<lines.length;i++){
            const L = lines[i];
            if(isFence(L)){
              inCode = !inCode; buf.push(L); if(!started) started = true; if(inCode===true) seenBody = true; continue;
            }
            if(!inCode && isHeading(L)){
              if(started && seenBody){ flush(); }
              // ä»å¤„äºâ€œæ ‡é¢˜è¿ç»­åŒºé—´â€æˆ–åˆšå¼€å§‹ä¸€ä¸ªæ–°æ®µ
              buf.push(L);
              started = true;
              continue;
            }
            // éæ ‡é¢˜è¡Œ
            buf.push(L);
            if(isNonEmpty(L)) { started = true; if(!/^\s*$/.test(L)) seenBody = true; }
          }
          flush();
          // å¦‚æœæ²¡æœ‰ä»»ä½•æ®µä¸”åŸæ–‡éç©ºï¼Œå›é€€ä¸ºæ•´ç¯‡
          if(segs.length===0 && md.trim()) return [md.trim()];
          return segs.filter(Boolean);
        }
        function fnv1a(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h+((h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24)))>>>0; } return ('00000000'+(h>>>0).toString(16)).slice(-8); }
        let rawMd=''; let segs=[]; let idx=0; let docHash='';
        function save(){ try{ localStorage.setItem('mem_progress:'+docHash, JSON.stringify({ nextIndex: idx, total: segs.length, ts: Date.now(), ver:1 })); }catch(e){} }
        function load(){ try{ return JSON.parse(localStorage.getItem('mem_progress:'+docHash)||'{}'); }catch(e){ return {}; } }
        function renderPanel(){
          const left = document.querySelector('.left-panel'); if(!left) return;
          // éšè—åŸå·¦ä¾§å¤æ‚æ¨¡å—ï¼Œé¿å…å¹²æ‰°ï¼›ä¸åˆ é™¤ä»¥é˜²å…¶ä»–è„šæœ¬ç»‘å®šæ—¶æŠ¥é”™
          try{ const hideSel=['.folder-processor-section','.ai-config-section','.content-viewer-section']; hideSel.forEach(s=>left.querySelectorAll(s).forEach(e=>{ e.style.display='none'; })); }catch(e){}
          let wrap = left.querySelector('.mem-panel'); if(!wrap){ wrap = document.createElement('div'); wrap.className='mem-panel'; left.appendChild(wrap); }
          wrap.innerHTML = '<div class="config-header"><h3>Markdown ç¼–è¾‘å™¨</h3></div>'+
            '<div style="padding:10px;display:grid;grid-template-columns:auto auto 1fr auto;gap:8px;align-items:center">'+
            '<button id="mem-start" class="primary-btn">å¼€å§‹</button>'+
            '<button id="mem-resume" class="secondary-btn">ç»§ç»­</button>'+
            '<span id="mem-docname" style="font-size:12px;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">æœªåŠ è½½MD</span>'+
            '<button id="mem-choose" class="secondary-btn">æ‰“å¼€MDæ–‡ä»¶</button>'+
            '<input id="mem-file" type="file" accept=".md,.markdown,.txt" style="display:none" />'+
            '</div>'+
            '<div id="mem-preview" class="markdown-sync-display" style="margin:8px"></div>'+
            '<div style="padding:6px 10px;color:#666;font-size:12px"><span id="mem-prog">æœªå¼€å§‹</span></div>';
          left.style.display='flex'; left.style.visibility='visible';
          // å…œåº•ï¼šå°è¯•ä»æœ¬åœ°æœåŠ¡è¯»å– mindmap_init_mdï¼ˆçˆ¶é¡µä¿å­˜ï¼‰
          try{
            const base = (window.__AM_BASE__ || '');
            fetch((base? (base + '/export-settings') : '/export-settings')).then(r=>r.ok?r.json():null).then(cfg=>{
              if(!rawMd && cfg && cfg.mindmap_init_md){
                rawMd = String(cfg.mindmap_init_md||'');
                docHash = fnv1a(rawMd);
                const tmp=splitByDeepest(rawMd); segs=tmp; idx=0;
                const pv=document.getElementById('mem-preview'); if(pv) pv.innerHTML=(function(md){ try{ const esc=(s)=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); let h=esc(md); h=h.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,function(_m,a,s){ if(/^data:image\//.test(s)||/^https?:\/\//.test(s)){ return '<div style=\"margin:6px 0\"><img alt=\"'+esc(a||'')+'\" src=\"'+s+'\" style=\"max-width:100%\"/></div>'; } return _m;}); return h; }catch(_e){ return md; }})(tmp[0]||'');
                const pg=document.getElementById('mem-prog'); if(pg) pg.textContent=tmp.length?('å°±ç»ª 1/'+tmp.length):'å°±ç»ª';
              }
            }).catch(()=>{});
          }catch(e){}
          document.getElementById('mem-choose').onclick=()=>document.getElementById('mem-file').click();
          document.getElementById('mem-file').addEventListener('change',e=>{
            const f=e.target.files&&e.target.files[0]; if(!f) return; document.getElementById('mem-docname').textContent=f.name;
            const r=new FileReader(); r.onload=()=>{ rawMd=String(r.result||''); docHash=fnv1a(rawMd); const tmp=splitByDeepest(rawMd); segs=tmp; idx=0; document.getElementById('mem-preview').innerHTML=(function(md){ try{ const esc=(s)=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); let h=esc(md); h=h.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,function(_m,a,s){ if(/^data:image\//.test(s)||/^https?:\/\//.test(s)){ return '<div style=\"margin:6px 0\"><img alt=\"'+esc(a||'')+'\" src=\"'+s+'\" style=\"max-width:100%\"/></div>'; } return _m;}); return h; }catch(_e){ return md; }})(tmp[0]||''); document.getElementById('mem-prog').textContent = tmp.length?('å°±ç»ª 1/'+tmp.length):'å°±ç»ª'; save(); }; r.readAsText(f,'utf-8');
          });
          document.getElementById('mem-start').onclick=()=>{ if(!rawMd){ document.getElementById('mem-prog').textContent='è¯·å…ˆåŠ è½½MD'; return; } segs=splitByDeepest(rawMd); idx=0; push(); };
          document.getElementById('mem-resume').onclick=()=>{ if(!rawMd){ document.getElementById('mem-prog').textContent='è¯·å…ˆåŠ è½½MD'; return; } segs=splitByDeepest(rawMd); const p=load(); idx=Math.min((p&&p.nextIndex!=null)?p.nextIndex:0, segs.length-1); push(); };
        }
        async function push(){
          if(!segs.length) return;
          const ta = document.getElementById('markdown-input');
          const text = stripBase64Imgs(segs[idx]||'');
          // ä»…æŠŠåˆ†æ®µæ–‡æœ¬æ”¾å…¥å³ä¾§è¾“å…¥ï¼›æ€ç»´å¯¼å›¾ API è°ƒç”¨äº¤ç”±å³ä¾§é€»è¾‘æŒ‰æœ¬åœ°/7860è®¾ç½®æ‰§è¡Œ
          if(ta){ ta.value = text; }
          try{ window.__mem_pre_api = false; }catch(_e){}
          // æ”¹ä¸ºè§¦å‘å³ä¾§â€œæœ—è¯»å†…å®¹â€ï¼ˆgenerate-btnï¼‰ï¼Œç¡®ä¿èµ°ç»Ÿä¸€è¯»å–/acké“¾è·¯ï¼›åŒæ—¶è§¦å‘ input äº‹ä»¶ä½¿è„šæœ¬æ„ŸçŸ¥å˜æ›´
          try{ if(ta){ const evt = new Event('input', { bubbles:true }); ta.dispatchEvent(evt); } }catch(_e){}
          const genBtn = document.getElementById('generate-btn'); if(genBtn){ genBtn.click(); } else { const readBtn = document.getElementById('read-markdown-btn'); if(readBtn){ readBtn.click(); } }
          document.getElementById('mem-preview').innerHTML = (function(md){
            try{ const esc=(s)=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); let h=esc(md); h=h.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,function(_m,a,s){ if(/^data:image\//.test(s)||/^https?:\/\//.test(s)){ return '<div style="margin:6px 0"><img alt="'+esc(a||'')+'" src="'+s+'" style="max-width:100%"/></div>'; } return _m;}); return h; }catch(_e){ return md; }
          })(segs[idx]||'');
          document.getElementById('mem-prog').textContent = `è¿›åº¦ ${idx+1}/${segs.length}`;
          save();
        }
        window.addEventListener('message',ev=>{ const d=ev.data||{}; if(d.type==='mem-set-md'){ rawMd = String(d.text||''); docHash = fnv1a(rawMd); const tmp=splitByDeepest(rawMd); segs=tmp; idx=0; const left=document.querySelector('.left-panel'); if(left && !left.querySelector('.mem-panel')) renderPanel(); const pv=document.getElementById('mem-preview'); if(pv) pv.innerHTML = (function(md){ try{ const esc=(s)=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); let h=esc(md); h=h.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,function(_m,a,s){ if(/^data:image\//.test(s)||/^https?:\/\//.test(s)){ return '<div style=\"margin:6px 0\"><img alt=\"'+esc(a||'')+'\" src=\"'+s+'\" style=\"max-width:100%\"/></div>'; } return _m;}); return h; }catch(_e){ return md; }})(tmp[0]||''); const pg=document.getElementById('mem-prog'); if(pg) pg.textContent = tmp.length?('å°±ç»ª 1/'+tmp.length):'å°±ç»ª'; }
          // ack ç”±å³ä¾§APIå®Œæˆåå‘é€ï¼Œè¿™é‡Œåªè´Ÿè´£æ¨è¿›
          else if(d.type==='mem-ack'){ idx = Math.min(idx+1, segs.length); if(idx<segs.length) { push(); } else { const pg=document.getElementById('mem-prog'); if(pg) pg.textContent = `å·²å®Œæˆ ${segs.length}/${segs.length}`; save(); } }
          else if(d.type==='mem-begin'){
            // å¤–éƒ¨è§¦å‘å¼€å§‹/ç»§ç»­
            try{
              if(!rawMd){ const pv=document.getElementById('mem-preview'); if(pv) pv.textContent='æœªåŠ è½½MD'; return; }
              segs = splitByDeepest(rawMd);
              const p = load();
              idx = Math.min((p&&p.nextIndex!=null)?p.nextIndex:0, segs.length-1);
              push();
            }catch(_e){}
          }
        });
        document.addEventListener('DOMContentLoaded', function(){ renderPanel(); try{ var localInit = localStorage.getItem('mindmap_init_md')||''; if(localInit && !rawMd){ rawMd = String(localInit); docHash = fnv1a(rawMd); const tmp=splitByDeepest(rawMd); segs=tmp; idx=0; const pv=document.getElementById('mem-preview'); if(pv) pv.textContent=tmp[0]||''; const pg=document.getElementById('mem-prog'); if(pg) pg.textContent=tmp.length?('å°±ç»ª 1/'+tmp.length):'å°±ç»ª'; } }catch(e){} });
      })();

      // æ¥æ”¶ä¸»åº”ç”¨å‘é€çš„åˆ†æ®µæ–‡æœ¬ï¼Œå†™å…¥å³ä¾§è¾“å…¥ï¼›ä¸åœ¨è¿™é‡Œ ackï¼Œç”±å³ä¾§ API å®Œæˆå ack
      (function(){
        function onMsg(ev){
          try{
            const d = ev.data || {};
            if(d.type === 'mem-segment'){
              // å°†æ–‡æœ¬å†™å…¥ markdown è¾“å…¥æ¡†
              const ta = document.getElementById('markdown-input');
              if(ta){ ta.value = d.text || ''; }
              // è§¦å‘å¯¼å›¾åˆ·æ–°æŒ‰é’®
              const btn = document.getElementById('generate-btn');
              if(btn){ btn.click(); }
              // æ³¨æ„ï¼šack æ”¹ä¸ºåœ¨ script.js ä¸­ API æˆåŠŸåå‘é€
            }
            else if(d.type === 'mem-set-config'){
              // ä»çˆ¶é¡µæ¥æ”¶é…ç½®ï¼Œåº”ç”¨åˆ° UI ä¸ localStorageï¼Œå¹¶æŒä¹…åŒ–åˆ°æœ¬åœ°æœåŠ¡
              try{
                const cfg = d.cfg || {};
                const apiBase = (cfg.api_base != null) ? String(cfg.api_base) : null;
                const model = (cfg.model != null) ? String(cfg.model) : null;
                const sys   = (cfg.sys   != null) ? String(cfg.sys)   : null;
                const user  = (cfg.user  != null) ? String(cfg.user)  : null;
                const key   = (cfg.key   != null) ? String(cfg.key)   : null;
                // å†™ UI
                try{ var el=document.getElementById('mindmap-api-base'); if(el && apiBase!=null){ el.value=apiBase; } }catch(_e){}
                try{ var el=document.getElementById('mindmap-model-select'); if(el && model!=null){ el.value=model; } }catch(_e){}
                try{ var el=document.getElementById('mindmap-system-prompt'); if(el && sys!=null){ el.value=sys; } }catch(_e){}
                try{ var el=document.getElementById('mindmap-user-prompt-template'); if(el && user!=null){ el.value=user; } }catch(_e){}
                try{ var el=document.getElementById('mindmap-api-key'); if(el && key!=null){ el.value=key; } }catch(_e){}
                // å†™ localStorage
                try{ if(apiBase!=null) localStorage.setItem('mindmap-api-base', apiBase); }catch(_e){}
                try{ if(model!=null) localStorage.setItem('mindmap-model', model); }catch(_e){}
                try{ if(sys!=null) localStorage.setItem('mindmap-system-prompt', sys); }catch(_e){}
                try{ if(user!=null) localStorage.setItem('mindmap-user-prompt-template', user); }catch(_e){}
                try{ if(key!=null) localStorage.setItem('mindmap-api-key', key); }catch(_e){}
                // æŒä¹…åŒ–åˆ°æœåŠ¡ç«¯ï¼ˆåŒæº preferredï¼‰
                try{
                  const base = (window.__AM_BASE__ || '');
                  const payload = {
                    mindmap_api_base: apiBase!=null?apiBase:'',
                    mindmap_model: model!=null?model:'',
                    mindmap_system_prompt: sys!=null?sys:'',
                    mindmap_user_prompt: user!=null?user:'',
                    mindmap_api_key: key!=null?key:'',
                    ui_values: {
                      'mindmap-api-base': apiBase!=null?apiBase:'',
                      'mindmap-model-select': model!=null?model:'',
                      'mindmap-system-prompt': sys!=null?sys:'',
                      'mindmap-user-prompt-template': user!=null?user:'',
                      'mindmap-api-key': key!=null?key:''
                    }
                  };
                  fetch((base? (base + '/save-settings') : '/save-settings'),{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }).catch(()=>{});
                }catch(_e){}
              }catch(_ee){}
            }
          }catch(e){}
        }
        // æ”¾å®½ postMessage æ¥æºé™åˆ¶ï¼Œå…¼å®¹ä»£ç†/ä¸åŒæºåµŒå…¥
        try{
          window.addEventListener('message', function(ev){ try{ onMsg(ev); }catch(_e){} }, false);
        }catch(_e){ window.addEventListener('message', onMsg, false); }
        // å…¼å®¹ huggingface ä»£ç†ï¼šå¼ºåˆ¶æ¥å—æ¥è‡ªä»»ä½•æºçš„æ³¨å…¥ï¼ˆçˆ¶é¡µå·²åšäº†å®‰å…¨æ ¡éªŒï¼‰
        try{
          const origPM = window.postMessage.bind(window);
          window.postMessage = function(msg, origin){ return origPM(msg, '*'); };
        }catch(e){}
      })();
    </script>
</head>
<body>
    <div class="main-container">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
            <!-- æ–‡ä»¶å¤¹å¤„ç†å™¨ -->
            <div class="folder-processor-section">
                <div class="config-header">
                    <h3>ğŸ“ æ–‡ä»¶å¤¹å¤„ç†å™¨</h3>
                    <button id="toggle-folder-config-btn" class="toggle-btn">å±•å¼€é…ç½®</button>
                </div>
                <div class="folder-config-content" id="folder-config-content">
                    <!-- è§†è§‰è¯†åˆ«æ¨¡å‹é…ç½® -->
                    <div class="model-config-group">
                        <h4>è§†è§‰è¯†åˆ«æ¨¡å‹</h4>
                        <div class="model-selection">
                            <label for="vision-model-select">é€‰æ‹©è§†è§‰æ¨¡å‹ï¼š</label>
                            <select id="vision-model-select">
                                <option value="step-1o-turbo-vision">é˜¶è·ƒæ˜Ÿè¾° 1o Turbo Vision</option>
                                <option value="gpt-4-vision">GPT-4 Vision</option>
                                <option value="claude-vision">Claude Vision</option>
                            </select>
                        </div>
                        <div class="api-config">
                            <label for="vision-api-key">è§†è§‰æ¨¡å‹APIå¯†é’¥ï¼š</label>
                            <div class="api-key-container">
                                <input type="password" id="vision-api-key" placeholder="è¾“å…¥è§†è§‰æ¨¡å‹APIå¯†é’¥..." class="api-input">
                                <button id="toggle-vision-api-visibility" class="visibility-btn">ğŸ‘ï¸</button>
                                <button id="save-vision-api-key" class="save-btn">ä¿å­˜</button>
                            </div>
                        </div>
                        <div class="prompt-config">
                            <label for="vision-system-prompt">è§†è§‰æ¨¡å‹ç³»ç»Ÿæç¤ºè¯ï¼š</label>
                            <textarea id="vision-system-prompt" placeholder="è¯·è¾“å…¥è§†è§‰æ¨¡å‹çš„ç³»ç»Ÿæç¤ºè¯..." rows="3">ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è§†è§‰å†…å®¹åˆ†æä¸“å®¶ï¼Œè¯·è¯¦ç»†æè¿°å›¾ç‰‡æˆ–PDFä¸­çš„å†…å®¹ï¼ŒåŒ…æ‹¬æ–‡å­—ã€å›¾è¡¨ã€ç»“æ„ã€å…³é”®ä¿¡æ¯ç­‰ã€‚</textarea>
                            
                            <label for="vision-user-prompt-template">è§†è§‰æ¨¡å‹ç”¨æˆ·æç¤ºè¯æ¨¡æ¿ï¼š</label>
                            <textarea id="vision-user-prompt-template" placeholder="è¯·è¾“å…¥è§†è§‰æ¨¡å‹çš„ç”¨æˆ·æç¤ºè¯æ¨¡æ¿..." rows="2">è¯·è¯¦ç»†åˆ†æè¿™å¼ å›¾ç‰‡/PDFçš„å†…å®¹ï¼Œæå–æ‰€æœ‰æ–‡å­—å’Œå…³é”®ä¿¡æ¯ã€‚</textarea>
                        </div>
                    </div>
                    
                    <!-- æ€ç»´å¯¼å›¾ç”Ÿæˆæ¨¡å‹é…ç½® -->
                    <div class="model-config-group">
                        <h4>æ€ç»´å¯¼å›¾ç”Ÿæˆæ¨¡å‹</h4>
                        <div class="model-selection">
                            <label for="mindmap-model-select">é€‰æ‹©æ€ç»´å¯¼å›¾æ¨¡å‹ï¼š</label>
                            <select id="mindmap-model-select">
                                <option value="kimi-k2-0711-preview">kimi-k2-0711-preview</option>
                                <option value="qwen">é€šä¹‰åƒé—® (Qwen)</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-3.5">GPT-3.5 Turbo</option>
                                <option value="claude">Claude</option>
                                <option value="gemini">Gemini</option>
                            </select>
                        </div>
                        <div class="api-config">
                            <label for="mindmap-api-key">æ€ç»´å¯¼å›¾æ¨¡å‹APIå¯†é’¥ï¼š</label>
                            <div class="api-key-container">
                                <input type="password" id="mindmap-api-key" placeholder="è¾“å…¥æ€ç»´å¯¼å›¾æ¨¡å‹APIå¯†é’¥..." class="api-input">
                                <button id="toggle-mindmap-api-visibility" class="visibility-btn">ğŸ‘ï¸</button>
                                <button id="save-mindmap-api-key" class="save-btn">ä¿å­˜</button>
                            </div>
                        </div>
                        <div class="api-config">
                            <label for="mindmap-api-base">API Baseï¼š</label>
                            <div class="api-key-container">
                                <input type="text" id="mindmap-api-base" placeholder="å¦‚ https://api.moonshot.cn æˆ–ç½‘å…³åœ°å€" class="api-input">
                                <button id="save-mindmap-api-base" class="save-btn">ä¿å­˜</button>
                            </div>
                        </div>
                        <div class="prompt-config">
                            <label for="mindmap-system-prompt">æ€ç»´å¯¼å›¾æ¨¡å‹ç³»ç»Ÿæç¤ºè¯ï¼š</label>
                            <textarea id="mindmap-system-prompt" placeholder="è¯·è¾“å…¥æ€ç»´å¯¼å›¾æ¨¡å‹çš„ç³»ç»Ÿæç¤ºè¯..." rows="4">ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å†…å®¹åˆ†æå’Œæ€ç»´å¯¼å›¾ç”Ÿæˆä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„å†…å®¹ï¼Œç”Ÿæˆä¸€ä¸ªç»“æ„æ¸…æ™°ã€å±‚æ¬¡åˆ†æ˜çš„æ€ç»´å¯¼å›¾ã€‚ä½¿ç”¨Markdownæ ¼å¼ï¼Œä»¥ä¸­å¿ƒä¸»é¢˜å¼€å§‹ï¼Œé€æ­¥å±•å¼€åˆ†æ”¯ä¸»é¢˜ï¼Œæ¯ä¸ªä¸»é¢˜éƒ½è¦ç®€æ´æ˜äº†ã€‚ä½¿ç”¨é€‚å½“çš„å±‚çº§ç»“æ„ï¼ˆ#ã€##ã€###ç­‰ï¼‰æ¥è¡¨ç¤ºæ€ç»´å¯¼å›¾çš„å±‚æ¬¡å…³ç³»ã€‚ç¡®ä¿å†…å®¹é€»è¾‘æ¸…æ™°ï¼Œé‡ç‚¹çªå‡ºï¼Œä¾¿äºç†è§£å’Œè®°å¿†ã€‚</textarea>
                            
                            <label for="mindmap-user-prompt-template">æ€ç»´å¯¼å›¾æ¨¡å‹ç”¨æˆ·æç¤ºè¯æ¨¡æ¿ï¼š</label>
                            <textarea id="mindmap-user-prompt-template" placeholder="è¯·è¾“å…¥æ€ç»´å¯¼å›¾æ¨¡å‹çš„ç”¨æˆ·æç¤ºè¯æ¨¡æ¿..." rows="3">è¯·æ ¹æ®ä»¥ä¸‹å†…å®¹ç”Ÿæˆä¸€ä¸ªç»“æ„åŒ–çš„æ€ç»´å¯¼å›¾ï¼š{content}</textarea>
                            <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                              <button id="save-all-settings-btn" class="save-btn">ä¿å­˜é…ç½®</button>
                              <span id="save-all-hint" style="font-size:12px;color:#666;display:none;">å·²ä¿å­˜</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ–‡ä»¶å¤¹é€‰æ‹© -->
                    <div class="folder-selection">
                        <label for="folder-input">é€‰æ‹©æ–‡ä»¶å¤¹ï¼š</label>
                        <input type="file" id="folder-input" webkitdirectory directory multiple accept="image/*,application/pdf" style="display: none;">
                        <button id="select-folder-btn" class="primary-btn">ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹</button>
                        <span id="selected-folder-name" style="margin-left: 10px; color: #666;"></span>
                    </div>
                    
                    <!-- å¤„ç†è¿›åº¦ -->
                    <div class="processing-progress" id="processing-progress" style="display: none;">
                        <div class="progress-info">
                            <span id="current-file-name">å‡†å¤‡å¤„ç†...</span>
                            <span id="progress-counter">0/0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="processing-status" id="processing-status">ç­‰å¾…å¼€å§‹...</div>
                    </div>
                    
                    <!-- è§†è§‰æ¨¡å‹è¿”å›ç»“æœ -->
                    <div class="vision-result-section">
                        <h4>è§†è§‰æ¨¡å‹è¿”å›ç»“æœ</h4>
                        <textarea id="vision-result-display" class="vision-result-display" placeholder="å¤„ç†å®Œæˆåï¼Œè§†è§‰æ¨¡å‹çš„è¿”å›ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." rows="8" readonly></textarea>
                    </div>
                    
                    <!-- å›ºå®šæœ—è¯»å†…å®¹é…ç½® -->
                    <div class="model-config-group">
                        <h4>å›ºå®šæœ—è¯»å†…å®¹</h4>
                        <div class="prompt-config">
                            <label for="fixed-reading-text">æ¯æ–‡ä»¶æœ—è¯»ç»“æŸåæœ—è¯»çš„å†…å®¹ï¼š</label>
                            <textarea id="fixed-reading-text" placeholder="è¯·è¾“å…¥æœ—è¯»å†…å®¹..." rows="3">æœ¬ç›´æ’­é—´ä»…ä¸ºåŒ»å­¦è€ƒç ”ç›´æ’­ï¼ŒéåŒ»ç–—è¡Œä¸ºã€‚</textarea>
                            <div class="checkbox-option">
                                <input type="checkbox" id="enable-fixed-reading" checked>
                                <label for="enable-fixed-reading">å¯ç”¨å›ºå®šæœ—è¯»</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ•æ„Ÿè¯è¿‡æ»¤é…ç½® -->
                    <div class="model-config-group">
                        <h4>æ•æ„Ÿè¯è¿‡æ»¤</h4>
                        <div style="background-color: #fff3cd; padding: 10px; border-left: 4px solid #ffc107; margin-bottom: 15px; border-radius: 4px;">
                            <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong> å¦‚éœ€ä½¿ç”¨æ•æ„Ÿè¯è¿‡æ»¤åŠŸèƒ½ï¼Œè¯·å…ˆåœ¨ä¸‹æ–¹é…ç½®APIå¯†é’¥ï¼<br>
                            <small>è¯·åˆ° <a href="https://check51.cn" target="_blank" style="color: #007bff;">check51.cn</a> æ³¨å†Œè·å–AppIDå’Œå¯†é’¥</small>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="enable-sensitive-filter" checked>
                            <label for="enable-sensitive-filter">å¯ç”¨æ•æ„Ÿè¯è¿‡æ»¤</label>
                        </div>
                        <div class="radio-group" style="margin-left: 20px; margin-top: 5px;">
                            <label><input type="radio" name="sensitive-filter-mode" value="voice-only" checked> ä»…è¯­éŸ³æ¶ˆéŸ³ï¼ˆæ–‡å­—æ˜¾ç¤ºå®Œæ•´ï¼‰</label>
                            <label><input type="radio" name="sensitive-filter-mode" value="both"> æ–‡å­—å’Œè¯­éŸ³éƒ½æ‹¦æˆª</label>
                        </div>
                        <div class="api-config">
                            <label for="banned-words-appid">è¿ç¦è¯æ£€æµ‹AppIDï¼š</label>
                            <div class="api-key-container">
                                <input type="text" id="banned-words-appid" placeholder="è¾“å…¥è¿ç¦è¯æ£€æµ‹AppID..." class="api-input">
                            </div>
                        </div>
                        <div class="api-config">
                            <label for="banned-words-secret">è¿ç¦è¯æ£€æµ‹å¯†é’¥ï¼š</label>
                            <div class="api-key-container">
                                <input type="password" id="banned-words-secret" placeholder="è¾“å…¥è¿ç¦è¯æ£€æµ‹å¯†é’¥..." class="api-input">
                                <button id="toggle-banned-words-secret" class="visibility-btn">ğŸ‘ï¸</button>
                            </div>
                        </div>
                        
                        <!-- è¡Œä¸šé€‰æ‹© -->
                        <div class="filter-options">
                            <label>æ‹¦æˆªè¡Œä¸šï¼ˆå¤šé€‰ï¼‰ï¼š</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" class="industry-filter" value="åŒ»ç–—" checked> åŒ»ç–—</label>
                                <label><input type="checkbox" class="industry-filter" value="é‡‘è" checked> é‡‘è</label>
                                <label><input type="checkbox" class="industry-filter" value="æ•™è‚²" checked> æ•™è‚²</label>
                                <label><input type="checkbox" class="industry-filter" value="æ³•å¾‹" checked> æ³•å¾‹</label>
                                <label><input type="checkbox" class="industry-filter" value="æ”¿æ²»" checked> æ”¿æ²»</label>
                                <label><input type="checkbox" class="industry-filter" value="å®—æ•™" checked> å®—æ•™</label>
                                <label><input type="checkbox" class="industry-filter" value="åšå½©" checked> åšå½©</label>
                                <label><input type="checkbox" class="industry-filter" value="æˆäºº" checked> æˆäºº</label>
                            </div>
                        </div>
                        
                        <!-- å¹³å°é€‰æ‹© -->
                        <div class="filter-options">
                            <label>æ‹¦æˆªå¹³å°ï¼ˆå¤šé€‰ï¼‰ï¼š</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" class="platform-filter" value="æŠ–éŸ³" checked> æŠ–éŸ³</label>
                                <label><input type="checkbox" class="platform-filter" value="å¿«æ‰‹" checked> å¿«æ‰‹</label>
                                <label><input type="checkbox" class="platform-filter" value="å¾®ä¿¡" checked> å¾®ä¿¡</label>
                                <label><input type="checkbox" class="platform-filter" value="å¾®åš" checked> å¾®åš</label>
                                <label><input type="checkbox" class="platform-filter" value="å°çº¢ä¹¦" checked> å°çº¢ä¹¦</label>
                                <label><input type="checkbox" class="platform-filter" value="Bç«™" checked> Bç«™</label>
                                <label><input type="checkbox" class="platform-filter" value="çŸ¥ä¹" checked> çŸ¥ä¹</label>
                                <label><input type="checkbox" class="platform-filter" value="æ·˜å®" checked> æ·˜å®</label>
                            </div>
                        </div>
                    </div>


                    
                    <!-- æ–‡ä»¶å¤¹å¤„ç†æ“ä½œ -->
                    <div class="folder-actions">
                        <button id="start-folder-processing" class="primary-btn" disabled>ğŸš€ å¼€å§‹å¤„ç†</button>
                        <button id="pause-folder-processing" class="secondary-btn" disabled>â¸ï¸ æš‚åœ</button>
                        <button id="stop-folder-processing" class="secondary-btn" disabled>â¹ï¸ åœæ­¢</button>
                    </div>
                </div>
            </div>
            

        </div>
        
        <!-- å³ä¾§é¢æ¿ -->
        <div class="right-panel">
            <!-- Markdownç¼–è¾‘åŒºåŸŸ (ä¸Š1/2) -->
            <div class="markdown-section">
                <div class="markdown-header">
                    <h3>Markdown ç¼–è¾‘å™¨</h3>
                    <div class="markdown-controls">
                        <div class="input-options">
                            <div class="option-item">
                                <input type="checkbox" id="typing-effect" checked>
                                <label for="typing-effect">æœ—è¯»æ—¶ä½¿ç”¨æ‰“å­—æœºæ•ˆæœ</label>
                            </div>
                        </div>
                        
                        <div class="voice-settings">
                            <div class="voice-option">
                                <label for="voice-select">è¯­éŸ³é€‰æ‹©ï¼š</label>
                                <select id="voice-select">
                                    <option value="default">æµè§ˆå™¨é»˜è®¤è¯­éŸ³</option>
                                </select>
                            </div>
                            <div class="voice-option">
                                <label for="voice-speed">è¯­é€Ÿï¼š</label>
                                <input type="range" id="voice-speed" min="0.5" max="2" step="0.1" value="1">
                                <span id="speed-value">1.0</span>
                            </div>
                            <div class="voice-option">
                                <label for="voice-volume">éŸ³é‡ï¼š</label>
                                <input type="range" id="voice-volume" min="0" max="1" step="0.1" value="1">
                                <span id="volume-value">1.0</span>
                            </div>
                        </div>
                        
                        <div class="buttons" style="display:grid;grid-template-columns:repeat(4,1fr);grid-auto-rows:auto;gap:8px;">
                            <button id="generate-btn">æœ—è¯»å†…å®¹</button>
                            <button id="copy-btn">å¤åˆ¶å†…å®¹</button>
                            <button id="clear-btn">æ¸…ç©ºå†…å®¹</button>
                            <button id="toggle-mindmap-btn">éšè—å¯¼å›¾</button>
                            <button id="read-markdown-btn">æœ—è¯»åŸæ–‡</button>
                            <button id="download-btn">ä¸‹è½½ç»“æœ</button>
                            <button id="download-all-btn">åˆå¹¶ä¸‹è½½</button>
                            <button id="download-vision-btn">åˆå¹¶ä¸‹è½½åŸå§‹è§†è§‰</button>
                        </div>
                    </div>
                </div>
                <textarea id="markdown-input" placeholder="åœ¨æ­¤è¾“å…¥æˆ–ç¼–è¾‘Markdownæ–‡æœ¬..."></textarea>
            </div>
            
            <!-- æ–°å¢ï¼šMarkdown åŒæ­¥å±•ç¤ºåŒºåŸŸ -->
            <div id="markdown-sync-display" class="markdown-sync-display"></div>
            
            <!-- æ€ç»´å¯¼å›¾åŒºåŸŸ (ä¸‹1/2) -->
            <div class="mindmap-section">
                <div class="mindmap-header">
                    <h3>æ€ç»´å¯¼å›¾é¢„è§ˆ</h3>
                </div>
                <div id="mindmap-container"></div>
            </div>
        </div>
    </div>
    
    <script>
      // åœ¨ embed-settings æ¨¡å¼ä¸‹ï¼Œåªä¿ç•™â€œè§†è§‰è¯†åˆ«æ¨¡å‹ / æ€ç»´å¯¼å›¾ç”Ÿæˆæ¨¡å‹â€ä¸¤å—
      (function(){
        function run(){
          if(!document.body.classList.contains('embed-settings')) return;
          try{
            const fps = document.querySelector('.folder-processor-section');
            if(!fps) return;
            const container = document.getElementById('folder-config-content') || fps;
            // éšè—éç›®æ ‡çš„æ‰€æœ‰å—
            container.querySelectorAll('.model-config-group').forEach(function(g){
              const h = (g.querySelector('h4') && g.querySelector('h4').textContent) || '';
              if(!/è§†è§‰è¯†åˆ«æ¨¡å‹|æ€ç»´å¯¼å›¾ç”Ÿæˆæ¨¡å‹/.test(h)){
                g.style.display = 'none';
              }
            });
            const toHide = ['.folder-selection','.processing-progress','.vision-result-section','.folder-actions','.ai-config-section','.content-viewer-section'];
            toHide.forEach(function(sel){
              container.querySelectorAll(sel).forEach(function(e){ e.style.display = 'none'; });
            });
            // åœ¨è®¾ç½®é¡µé¡¶éƒ¨æ³¨å…¥ä¸€ä¸ªæ˜¾å¼çš„â€œä¿å­˜é…ç½®â€æŒ‰é’®
            try{
              let header = container.querySelector('.config-header');
              if(!header){ header = container; }
              if(header && !document.getElementById('save-all-settings-btn-top')){
                const wrap = document.createElement('div');
                wrap.style.cssText = 'display:flex;gap:8px;align-items:center;margin:8px 0;';
                wrap.innerHTML = '<button id="save-all-settings-btn-top" class="save-btn">ä¿å­˜é…ç½®</button><span id="save-all-hint-top" style="font-size:12px;color:#666;display:none;">å·²ä¿å­˜</span>';
                header.parentNode.insertBefore(wrap, header.nextSibling);
                const btn = wrap.querySelector('#save-all-settings-btn-top');
                const hint = wrap.querySelector('#save-all-hint-top');
                if(btn){
                  btn.addEventListener('click', function(){
                    try{
                      const payload = {
                        mindmap_api_base: (document.getElementById('mindmap-api-base')?.value || localStorage.getItem('mindmap-api-base') || ''),
                        mindmap_model: (document.getElementById('mindmap-model-select')?.value || localStorage.getItem('mindmap-model') || ''),
                        mindmap_system_prompt: (document.getElementById('mindmap-system-prompt')?.value || localStorage.getItem('mindmap-system-prompt') || ''),
                        mindmap_user_prompt: (document.getElementById('mindmap-user-prompt-template')?.value || localStorage.getItem('mindmap-user-prompt-template') || ''),
                        mindmap_api_key: (document.getElementById('mindmap-api-key')?.value || localStorage.getItem('mindmap-api-key') || ''),
                        ui_values: (function(){ const m={}; document.querySelectorAll('input,textarea,select').forEach(function(el){ if(!el.id) return; if(el.type==='checkbox'||el.type==='radio'){ m[el.id]=!!el.checked; } else { m[el.id]=el.value; } }); return m; })()
                      };
                      try{ localStorage.setItem('ui_values', JSON.stringify(payload.ui_values||{})); }catch(_e){}
                      try{ if(payload.mindmap_api_base!=null) localStorage.setItem('mindmap-api-base', payload.mindmap_api_base);}catch(_e){}
                      try{ if(payload.mindmap_model!=null) localStorage.setItem('mindmap-model', payload.mindmap_model);}catch(_e){}
                      try{ if(payload.mindmap_system_prompt!=null) localStorage.setItem('mindmap-system-prompt', payload.mindmap_system_prompt);}catch(_e){}
                      try{ if(payload.mindmap_user_prompt!=null) localStorage.setItem('mindmap-user-prompt-template', payload.mindmap_user_prompt);}catch(_e){}
                      try{ if(payload.mindmap_api_key!=null) localStorage.setItem('mindmap-api-key', payload.mindmap_api_key);}catch(_e){}
                      fetch('/save-settings', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) })
                        .then(()=>{ if(hint){ hint.style.display='inline'; setTimeout(()=>{ hint.style.display='none'; }, 1200); } });
                    }catch(_e){}
                  });
                }
              }
            }catch(_e){}
          }catch(e){}
        }
        document.addEventListener('DOMContentLoaded', run);
      })();
    </script>
    <!-- é€‰æ‹©åŒºåŸŸé®ç½©å±‚ -->
    <div id="selection-overlay" class="selection-overlay" style="display: none;">
        <div class="selection-instructions">
            <p>è¯·æ‹–æ‹½é€‰æ‹©è¦æˆªå›¾çš„åŒºåŸŸ</p>
            <button id="cancel-selection">å–æ¶ˆé€‰æ‹©</button>
        </div>
    </div>
    
    <!-- åŠ è½½æç¤º -->
    <div id="loading-indicator" class="loading-indicator" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loading-text">æ­£åœ¨å¤„ç†...</p>
        </div>
    </div>
    
    <script src="content-extractor.js?v=1"></script>
    <script src="ai-features.js?v=2"></script>
    <script src="settings-persistence.js?v=1"></script>
    <script>
      // å¯é€‰ï¼šå¦‚æœè„šæœ¬é‡Œéœ€è¦ç”¨åˆ° api baseï¼Œå¯ä» localStorage è¯»å–
      // ä¾‹å¦‚ï¼šwindow.MINDMAP_API_BASE = localStorage.getItem('mindmap-api-base') || '';
      window.MINDMAP_API_BASE = localStorage.getItem('mindmap-api-base') || '';
      try{ if(window.SettingsPersistence && typeof window.SettingsPersistence.bootstrap==='function'){ window.SettingsPersistence.bootstrap(); } }catch(e){}
    </script>
    <script src="debug-image-processing.js?v=1"></script>
    <script src="screenshot-fix.js?v=1"></script>
    <script src="folder-processor.js?v=1"></script>
    <script src="script.js?v=3"></script>
</body>
</html>