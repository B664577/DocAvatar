<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>敏感词过滤测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 3px;
        }
        .sensitive-word {
            background: #ffcccc;
            padding: 2px 4px;
            border-radius: 3px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>敏感词过滤功能测试</h1>
    
    <div class="test-section">
        <h2>测试敏感词检测API</h2>
        <textarea id="testText" placeholder="输入测试文本，包含可能的敏感词如：治疗、药物等">这是一个测试文本，包含治疗相关的敏感词汇。</textarea>
        <button onclick="testSensitiveWords()">测试敏感词检测</button>
        <div id="testResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>测试朗读过滤</h2>
        <textarea id="speechText" placeholder="输入要朗读的文本">今天我们来讨论治疗方法和药物使用。</textarea>
        <label>
            <input type="checkbox" id="enableFilter" checked> 启用敏感词过滤
        </label>
        <br><br>
        <button onclick="testSpeech()">测试朗读</button>
        <div id="speechResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>API配置</h2>
        <label>AppID:</label>
        <input type="text" id="appId" placeholder="输入AppID" style="width: 100%; margin: 5px 0;">
        <label>Secret Key:</label>
        <input type="password" id="secretKey" placeholder="输入Secret Key" style="width: 100%; margin: 5px 0;">
    </div>

    <script>
        // 敏感词检测功能
        async function detectSensitiveWords(text) {
            try {
                const appId = document.getElementById('appId').value;
                const secretKey = document.getElementById('secretKey').value;
                
                if (!appId || !secretKey) {
                    throw new Error('请先输入AppID和Secret Key');
                }

                // 过滤掉Markdown标识符，避免发送额外字符
            const cleanedText = text
                .replace(/^#{1,6}\s+/gm, '') // 移除标题标识 #
                .replace(/\*\*(.*?)\*\*/g, '$1') // 移除粗体 **text**
                .replace(/\*(.*?)\*/g, '$1') // 移除斜体 *text*
                .replace(/`(.*?)`/g, '$1') // 移除代码块 `code`
                .replace(/```[\s\S]*?```/g, '') // 移除多行代码块 ```code```
                .replace(/^\s*[-*+]\s+/gm, '') // 移除列表标识 - * +
                .replace(/^\s*\d+\.\s+/gm, '') // 移除数字列表 1.
                .replace(/\([^)]+\)/g, '$1') // 移除链接 [text](url)
                .replace(/!\[[^\]]*\]\([^)]+\)/g, '') // 移除图片 ![alt](url)
                .replace(/^[\s>]+/gm, '') // 移除引用标识 >
                .replace(/\|/g, '') // 移除表格分隔符 |
                .replace(/\n\s*\n/g, '\n') // 合并多余空行
                .trim();

            const formData = new FormData();
            formData.append('appid', appId);
            formData.append('secretKey', secretKey);
            formData.append('content', cleanedText.substring(0, 50000));
            formData.append('detectMode', '0');
            formData.append('isCommonWord', 'true');
            formData.append('encode', 'unicode');
            formData.append('isDefined', 'true');
                
                const response = await fetch('https://api.check51.cn/api/word/detect-text', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('API调用失败');
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('敏感词检测出错:', error);
                throw error;
            }
        }

        // 过滤敏感词
        function filterSensitiveWordsForSpeech(text, sensitiveWords) {
        if (!sensitiveWords || sensitiveWords.length === 0) {
            return text;
        }

        let filteredText = text;
        sensitiveWords.forEach(word => {
            const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
            // 使用逗号作为停顿标记，朗读时会停顿对应时间
            filteredText = filteredText.replace(regex, ','.repeat(Math.min(word.length, 3)));
        });

        return filteredText;
    }

        async function testSensitiveWords() {
            const text = document.getElementById('testText').value;
            const resultDiv = document.getElementById('testResult');
            
            resultDiv.innerHTML = '检测中...';
            
            try {
                const result = await detectSensitiveWords(text);
                let html = '<strong>检测结果:</strong><br>';
                
                if (result.code === '0000' && result.data) {
                    const data = result.data;
                    const riskList = data.riskList || [];
                    const topRiskStr = data.topRiskStr || '';
                    const lowRiskStr = data.lowRiskStr || '';
                    
                    // 合并所有敏感词
                    let allSensitiveWords = [];
                    if (topRiskStr) allSensitiveWords = allSensitiveWords.concat(topRiskStr.split('、'));
                    if (lowRiskStr) allSensitiveWords = allSensitiveWords.concat(lowRiskStr.split('、'));
                    allSensitiveWords = [...new Set(allSensitiveWords.filter(word => word.trim()))]; // 去重
                    
                    if (allSensitiveWords.length > 0) {
                        html += `发现 ${allSensitiveWords.length} 个敏感词: `;
                        html += allSensitiveWords.map(word => `<span class="sensitive-word">${word}</span>`).join(', ');
                        
                        if (topRiskStr) html += `<br><strong>禁用词:</strong> ${topRiskStr}`;
                        if (lowRiskStr) html += `<br><strong>敏感词:</strong> ${lowRiskStr}`;
                        
                        // 显示过滤后的文本
                        const filtered = filterSensitiveWordsForSpeech(text, allSensitiveWords);
                        html += '<br><br><strong>过滤后文本:</strong><br>';
                        html += filtered;
                        
                        // 显示详细信息
                        if (riskList.length > 0) {
                            html += '<br><br><strong>详细列表:</strong><br>';
                            riskList.forEach(item => {
                                html += `<div style="margin: 5px 0; padding: 5px; background: #f9f9f9; border-radius: 3px;">
                                    <strong>${item.title}</strong> - ${item.type} (${item.sourse})<br>
                                    <small>原因: ${item.reason}</small>
                                </div>`;
                            });
                        }
                    } else {
                        html += '未检测到敏感词';
                    }
                } else {
                    html += `API返回错误: ${result.msg || '未知错误'}`;
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `检测失败: ${error.message}`;
            }
        }

        function testSpeech() {
            const text = document.getElementById('speechText').value;
            const enableFilter = document.getElementById('enableFilter').checked;
            const resultDiv = document.getElementById('speechResult');
            
            if (enableFilter) {
                // 模拟敏感词检测
                const sensitiveWords = ['治疗', '药物'];
                const filtered = filterSensitiveWordsForSpeech(text, sensitiveWords);
                
                resultDiv.innerHTML = `
                    <strong>原文:</strong> ${text}<br>
                    <strong>敏感词:</strong> ${sensitiveWords.join(', ')}<br>
                    <strong>过滤后朗读文本:</strong> ${filtered}
                `;
                
                // 实际朗读过滤后的文本
                speakText(filtered);
            } else {
                resultDiv.innerHTML = `<strong>朗读原文:</strong> ${text}`;
                speakText(text);
            }
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                speechSynthesis.speak(utterance);
            } else {
                alert('浏览器不支持语音朗读');
            }
        }
    </script>
</body>
</html>